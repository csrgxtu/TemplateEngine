<!DOCTYPE html>
<html>
  <head>
    <title>Title</title>
    <meta charset="utf-8">
    <style>
      @import url(https://fonts.googleapis.com/css?family=Yanone+Kaffeesatz);
      @import url(https://fonts.googleapis.com/css?family=Droid+Serif:400,700,400italic);
      @import url(https://fonts.googleapis.com/css?family=Ubuntu+Mono:400,700,400italic);

      body { font-family: 'Droid Serif'; }
      h1, h2, h3 {
        font-family: 'Yanone Kaffeesatz';
        font-weight: normal;
      }
      .remark-code, .remark-inline-code { font-family: 'Ubuntu Mono'; }
    </style>
  </head>
  <body>
    <textarea id="source">

class: center, middle

# Template Engine Internal
archer.li@shopeemobile.com

Software Engineer @ Sea Shopee


---
## Contents
* ### Why template engine?
* ### Basic principles
* ### A simple implementation
* ### Issues
* ### Reference


---

## Why template engine?
There are different kinds of programming tasks
* #### lots of logic
* #### text-heavy


```Python
# example text heavy
@route('/welcome')
def welcome():
  HMTL = "<center><h3>{username}</h3></center>".format(username='shopee')
  HMTL += "<center><p>{age}</p></center>".format(age=12)
  HMTL += "<center><p>Description:{desc}</p></center>".format(desc='template engine desc')
  return HMTL
```


---

## Basic Principles -- Goal
Turn following template:
```html
<html>
  Hello, {{ username }}!
  <ul>
    {% for job in job_list %}
      <li>{{ job }}</li>
    {% endfor %}
  </ul>
</html>
```
Into
```html
<html>
  Hello, archer!
  <ul>
      <li>engineer</li>
      <li>qa</li>
      <li>pm</li>
  </ul>
</html>
```

---
## Basic Principles -- methods

### String substitution
```Python
HTML_PAGE = """
<html>
  Hello, {{ username }}!
</html>
"""
HTML_PAGE.format(username='shopee')
```


### Code execution
1. #### Template String
2. #### Render_function in string representation
3. #### Python function object
4. #### HTML string


---
### Basic Principles -- methods(code execution)
Parse template string line by line and assemble the string representation of the render function
```Python
# string representation of the render function
"""
def render_function(context, do_dots):
    c_username = context['username']
    c_job_list = context['job_list']
    result = []
    append_result = result.append
    extend_result = result.extend
    to_str = str
    extend_result(['\n<html>\n  Hello, ', to_str(c_username), '!\n  <ul>\n    '])
    for c_job in c_job_list:
        extend_result(['\n      <li>', to_str(c_job), '</li>\n    '])
    append_result('\n  </ul>\n</html>\n')
    return ''.join(result)

"""
```
---
### Basic Principles -- methods(code execution) Continued
Use Exec turn string representation into a real function object
```Python
def render_function(context, do_dots):
    c_username = context['username']
    c_job_list = context['job_list']
    result = []
    append_result = result.append
    extend_result = result.extend
    to_str = str
    extend_result(['\n<html>\n  Hello, ', to_str(c_username), '!\n  <ul>\n    '])
    for c_job in c_job_list:
        extend_result(['\n      <li>', to_str(c_job), '</li>\n    '])
    append_result('\n  </ul>\n</html>\n')
    return ''.join(result)
```


---
## Basic Principles -- Interpreter & Compiler

Template == source file

Template Engine == Interpreter/Compiler

Template File = Static Part + Dynamic Part

Static Part:
* HTML tags
* String Literals

Dynamic Part:
* Expressions -- {{username}}
* Conditions -- {% if * %}
* Loop Control -- {% for * %}

---
## Basic Principles -- Category

* String substitution
* Code Execution
* Mixed

```bash
code execution                                          string substitution
<------------------------------------|------------------------------------->
moko                       Jinja2 | Django | etc          .format(**kwargs)
```

---
## A simple Implementation -- Parsing Phase
[Github - templite.py](https://github.com/csrgxtu/TemplateEngine/blob/500lines/templite.py)
```Python
class Templite(object):
    def __init__(self, text, *contexts):
        ...
        code = CodeBuilder()
        ...

        # Split the text to form a list of tokens.
        tokens = re.split(r"(?s)({{.*?}}|{%.*?%}|{#.*?#})", text)

        for token in tokens:
            if token.startswith('{#'):
                # Comment: ignore it and move on.
                continue
            elif token.startswith('{{'):
                # An expression to evaluate.
                expr = self._expr_code(token[2:-2].strip())
                buffered.append("to_str(%s)" % expr)
            elif token.startswith('{%'):
                # Action tag: split into words and parse further.
                flush_output()
                words = token[2:-2].strip().split()


```
---
## A simple Implementation -- Parsing Phase Continued
``` Python
                if words[0] == 'if':
                    # An if statement: evaluate the expression to determine if.
                    if len(words) != 2:
                        self._syntax_error("Don't understand if", token)
                    ops_stack.append('if')
                    code.add_line("if %s:" % self._expr_code(words[1]))
                    code.indent()

        self._render_function = code.get_globals()['render_function']

def get_globals(self):
    """Execute the code, and return a dict of globals it defines."""
    # A check that the caller really finished all the blocks they started.
    assert self.indent_level == 0
    # Get the Python source as a single string.
    python_source = str(self)
    # Execute the source, defining globals, and return them.
    global_namespace = {}
    exec(python_source, global_namespace)
    return global_namespace
```

---
## A simple Implementation -- Render Phase
``` Python
def render(self, context=None):
    """Render this template by applying it to `context`.

    `context` is a dictionary of values to use in this rendering.

    """
    # Make the complete context we'll use.
    render_context = dict(self.context)
    if context:
        render_context.update(context)
    return self._render_function(render_context, self._do_dots)
```

---
## Issues
* Template inheritance and inclusion
* Custom tags
* Automatic escaping
* Arguments to filters
* Complex conditional logic like else and elif
* Loops with more than one loop variable
* Whitespace control

---
class: center, middle
# QA & Thanks

---
## References
[How a template engine works](https://fengsp.github.io/blog/2016/8/how-a-template-engine-works/)

[The word's simpest template engine](https://makina-corpus.com/blog/metier/2016/the-worlds-simplest-python-template-engine)

[Template Engines -- Fullstack Python](https://www.fullstackpython.com/template-engines.html)

[TemplateEngine](https://github.com/csrgxtu/TemplateEngine/issues/1)



    </textarea>
    <script src="https://remarkjs.com/downloads/remark-latest.min.js">
    </script>
    <script>
      var slideshow = remark.create();
    </script>
  </body>
</html>
